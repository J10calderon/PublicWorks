<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PublicWorks</title>
    <link rel="stylesheet" href="styles.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <section id="auth">
        <div>
            <h2 className="sign-up-text">Login</h2>
        </div>

        <input id="usernameInput" placeholder="username"/>
        <input id="passwordInput" placeholder="********" type="password"/>
        <input id="firstname" placeholder="first name" style="display:none"/>
        <input id="lastname" placeholder="last name" style="display:none"/>
        <input id="email" placeholder="email" style="display:none">

        <button id="authBtn" onclick="authenticate()">
            Login
        </button>
    </section>
    <hr />
    <div class="register-content">
        <p>Don&apos;t have an account?</p>
        <button onclick="toggleIsRegister()" id="registerBtn">Sign up</button>
    </div>
    </section>
</body>
<script>
    let token = localStorage.getItem('token')

    let isLoading = false
    let isAuthenticating = false
    let isRegistration = false
    // let selectedTab = 'All'
    let incidents = []

    const apiBase = '/'

    // elements
    // const nav = document.querySelector('nav')
    // const header = document.querySelector('header')
    // const main = document.querySelector('main')
    // const navElements = document.querySelectorAll('.tab-button')
    // const authContent = document.getElementById('auth')
    // const textError = document.getElementById('error')
    const username = document.getElementById('usernameInput')
    const password = document.getElementById('passwordInput')

    const firstname = document.getElementById('firstname');
    const lastname = document.getElementById('lastname');
    const email = document.getElementById('email');
    // const registerBtn = document.getElementById('registerBtn')
    // const authBtn = document.getElementById('authBtn')
    // const addTodoBtn = document.getElementById('addTodoBtn')

    async function toggleIsRegister() {
    isRegistration = !isRegistration
    registerBtn.innerText = isRegistration ? 'Sign in' : 'Sign up'
    document.querySelector('#auth > div h2').innerText = isRegistration ? 'Sign Up' : 'Login'
    document.querySelector('#authBtn').innerText = isRegistration ? 'Sign Up' : 'Login'
    document.querySelector('.register-content p').innerText = isRegistration ? 'Already have an account?' : 'Don\'t have an account?'
    document.querySelector('.register-content button').innerText = isRegistration ? 'Sign in' : 'Sign up'

    document.querySelector('#firstname').style.display = isRegistration ? 'block' : 'none'
    document.querySelector('#lastname').style.display = isRegistration ? 'block' : 'none'
    document.querySelector('#email').style.display = isRegistration ? 'block' : 'none'
    }


    async function authenticate() {
    // access username and pass values
    const usernameVal = username.value
    const passVal = password.value
    const firstnameVal = firstname.value
    const lastnameVal = lastname.value
    const emailVal = email.value


    console.log('hello world')
    // guard clauses... if authenticating, return
    if (
        isLoading ||
        isAuthenticating ||
        !usernameVal ||
        !passVal ||
        passVal.length < 6
    ) { return }

    // reset error and set isAuthenticating to true
    // error.style.display = 'none'
    isAuthenticating = true
    authBtn.innerText = 'Authenticating...'

    try {
        let data
        if (isRegistration) {
            // register an account

            console.log('attempting to register') 
            const response = await fetch(apiBase + 'auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: usernameVal, password: passVal, firstname: firstnameVal, lastname:lastnameVal, email: emailVal})

            })
            data = await response.json()
        } else {
            // login an account
            const response = await fetch(apiBase + 'auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: usernameVal, password: passVal })
            })
            data = await response.json()
        }

        if (data.token) {
            token = data.token
            localStorage.setItem('token', token)

            // authenicating into loading
            authBtn.innerText = 'Loading...'

            // fetch todos
            // await fetchTodos()
            // await fetchIncidents()

            // show dashboard
            // showDashboard()
            
        } else {
            throw Error('âŒ Failed to authenticate...')
        }

    } catch (err) {
        console.log(err.message)
        // error.innerText = err.message
        // error.style.display = 'block'
    } finally {
        authBtn.innerText = 'Submit'
        isAuthenticating = false
    }

    //CRUD LOGIC

    async function fetchIncidents() {
        isLoading = true
        const response = await fetch(apiBase + 'incident', {
            headers: { 'Authorization': token }
        })
        const incidentData = await response.json()
        incidents = incidentData
        isLoading = false
        // renderTodos()
    }

    async function updateIncident(index) {
        // set task complete status to true
        await fetch(apiBase + 'incident' + '/' + index, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token
            },

            let incident = incidents.find(val => val.id === index)
            body: JSON.stringify({ task: todos.find(val => val.id === index).task, completed: 1 })
        })
        fetchIncidents()
    }

    async function deleteTodo(index) {
        // set task complete status to true
        await fetch(apiBase + 'todos' + '/' + index, {
            method: 'DELETE',
            headers: {
                'Authorization': token
            },
        })
        fetchTodos()
    }

    async function addTodo() {
        // have to access this val later as it's rendered with js
        const todoInput = document.getElementById('todoInput')
        const task = todoInput.value

        if (!task) { return }

        await fetch(apiBase + 'todos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token
            },
            body: JSON.stringify({ task })
        })
        todoInput.value = ''
        fetchTodos()
    }



    }   
</script>
</html>